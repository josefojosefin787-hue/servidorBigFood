<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Pedidos - Admin</title>
  <link rel="stylesheet" href="/styles.css">
  <style>
    :root{ --green:#0b8e4d; --accent:#34a853; --muted:#6b6b6b }
    body.pedidos-page{ margin:0;font-family:Inter,system-ui,-apple-system,'Segoe UI',sans-serif;min-height:100vh;display:flex;align-items:center;justify-content:center;padding:40px 12px;background:linear-gradient(140deg,#0b8e4d 0%,#34a853 55%,#0b5e28 100%); }
    .pedidos-card{ width:100%;max-width:1100px;background:rgba(255,255,255,0.98);border-radius:18px;padding:22px;box-shadow:0 30px 60px rgba(6,62,30,0.22); }
    .pedidos-card h1{ margin:0 0 12px;color:var(--green) }
    .table-wrap{ overflow:auto }
    table.pedidos-table{ width:100%;border-collapse:collapse;min-width:860px }
    table.pedidos-table th, table.pedidos-table td{ padding:12px 10px;border-bottom:1px solid #eee;text-align:left;vertical-align:middle }
    table.pedidos-table th{ background:linear-gradient(90deg,rgba(11,94,42,0.06),rgba(11,94,42,0.02));color:var(--green);font-weight:600 }
    .actions { display:flex; gap:8px }
    .btn{ background:var(--green); color:#fff; border:0; padding:8px 10px; border-radius:8px; cursor:pointer; font-weight:600 }
    .btn.secondary{ background:#f0ad4e }
    .btn.danger{ background:#d9534f }
    .status-badge{ padding:6px 10px;border-radius:999px;font-weight:700;display:inline-block }
    .status-pendiente{ background:#fff3cd;color:#856404 }
    .status-preparacion{ background:#cfe2ff;color:#084298 }
    .status-listo{ background:#d1e7dd;color:#0f5132 }
    .small{ font-size:0.9rem; color:var(--muted) }
    @media (max-width:900px){ .pedidos-card{ padding:18px } table.pedidos-table th, table.pedidos-table td{ padding:10px } }
  </style>
</head>
<body class="pedidos-page">
  <div class="pedidos-card">
    <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;margin-bottom:8px;">
      <div>
        <h1>Lista de pedidos</h1>
        <p class="small">Vista de administración — solo usuarios autenticados pueden ver y gestionar pedidos.</p>
      </div>
      <div id="adminSessionPanel" style="text-align:right;min-width:140px;max-width:480px;">
        <div id="adminSessionContent" style="display:flex;align-items:center;gap:10px;justify-content:flex-end;padding:4px;">
          <img id="adminAvatar" src="" alt="avatar" style="width:40px;height:40px;border-radius:999px;display:none;object-fit:cover;border:2px solid rgba(0,0,0,0.06)">
          <div style="text-align:left;min-width:90px;max-width:160px;overflow:hidden;">
            <div id="adminName" style="font-weight:700;color:#063;white-space:nowrap;text-overflow:ellipsis;overflow:hidden;">Invitado</div>
            <div id="adminEmail" style="font-size:0.75rem;color:#3b3b3b;white-space:nowrap;text-overflow:ellipsis;overflow:hidden">-</div>
          </div>
          <div style="display:flex;flex-direction:column;gap:6px;align-items:flex-end">
            <div id="adminPrivileges" style="font-size:0.75rem;color:#2f6a3d;white-space:nowrap">Privilegios: administrador</div>
            <div style="display:flex;gap:8px">
              <a href="/admin.html" class="btn" style="padding:6px 10px;font-size:0.9rem">Productos</a>
              <button id="btnLogout" class="btn" style="background:#fff;color:var(--green);padding:6px 10px;font-size:0.9rem">Cerrar sesión</button>
              <button id="btnArchiveToday" class="btn secondary" title="Archivar pedidos del día" style="padding:6px 10px;font-size:0.9rem">Archivar hoy</button>
              <button id="btnShowLive" class="btn" title="Volver a la lista actual (hoy)" style="padding:6px 10px;font-size:0.9rem;display:none">Lista actual - Hoy</button>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div style="display:flex;gap:12px;align-items:flex-start;margin-bottom:10px;">
      <div style="flex:0 0 100%;">
        <label style="font-weight:700;color:#063;display:block;margin-bottom:8px">Listas archivadas</label>
        <div style="background:#fafafa;border:1px solid #eee;padding:8px;border-radius:8px;">
          <table id="archivesTable" style="width:100%;border-collapse:collapse;font-size:0.95rem;">
            <thead>
              <tr style="text-align:left;color:#063;font-weight:700"><th style="padding:6px 8px">Fecha</th><th style="padding:6px 8px">Pedidos</th><th style="padding:6px 8px">Archivado por</th><th style="padding:6px 8px">Acciones</th></tr>
            </thead>
            <tbody id="archivesBody">
              <tr><td colspan="4" style="padding:8px;color:#666">Cargando listas archivadas...</td></tr>
            </tbody>
          </table>
        </div>
        <div style="margin-top:6px;color:#464646;font-size:0.9rem;"> <span id="archiveInfo"></span> </div>
      </div>
    </div>
    <div class="table-wrap">
      <table class="pedidos-table" aria-label="Lista de pedidos">
        <thead>
          <tr><th>ID</th><th>Cliente</th><th>Items</th><th>Total</th><th>Fecha</th><th>Estado</th><th>Acción</th></tr>
        </thead>
        <tbody id="tabla"></tbody>
      </table>
    </div>
  </div>

  <script>
    // admin-only page: verify session first
    let isViewingArchive = false;
    let currentArchiveDate = null;

    async function ensureAdmin() {
      try{
        const r = await fetch('/api/admin/session', { credentials: 'same-origin' });
        if (!r.ok) { window.location.href = '/admin-login.html'; return false; }
        const j = await r.json();
        if (!j || !j.admin) { window.location.href = '/admin-login.html'; return false; }
        // populate session panel
        const nameEl = document.getElementById('adminName');
        const emailEl = document.getElementById('adminEmail');
        const avatarEl = document.getElementById('adminAvatar');
        const privEl = document.getElementById('adminPrivileges');
        const logoutBtn = document.getElementById('btnLogout');
        nameEl.textContent = j.admin.name || j.admin.email || 'Administrador';
        emailEl.textContent = j.admin.email || '';
        // safe avatar handling
        if (j.admin.picture) {
          avatarEl.src = j.admin.picture;
          avatarEl.onload = () => { avatarEl.style.display = 'block'; };
          avatarEl.onerror = () => { avatarEl.style.display = 'none'; };
        } else { avatarEl.style.display = 'none'; }
        if (j.admin.privileges) privEl.textContent = 'Privilegios: ' + j.admin.privileges;
        else privEl.textContent = 'Privilegios: administrador';
        logoutBtn.onclick = async ()=>{ await fetch('/api/admin/logout', { method: 'POST', credentials: 'same-origin' }); window.location.href = '/admin-login.html'; };
        return true;
      }catch(e){ console.warn('ensureAdmin error', e); window.location.href = '/admin-login.html'; return false; }
    }

    async function cargar() {
      const ok = await ensureAdmin();
      if (!ok) return;

      if (isViewingArchive) return; // when viewing archive, don't load live pedidos

      const res = await fetch('/api/pedidos', { credentials: 'same-origin' });
      if (!res.ok) { console.error('Error fetching pedidos', res.status); return; }
      const pedidos = await res.json();
      renderPedidos(pedidos);
    }

    function renderPedidos(pedidos) {
      const tabla = document.getElementById('tabla');
      tabla.innerHTML = '';
      (pedidos||[]).slice().reverse().forEach(p=>{
        const tr = document.createElement('tr');
        const itemsHTML = (p.items||[]).map(i=> (i.cantidad||i.qty||1) + ' x ' + (i.nombre||i.name||i.product_code||i.product_code||'' )).join('<br>');
        const estadoRaw = String(p.estado||p.status||'').trim();
        const estadoSafe = estadoRaw.toLowerCase();
        let estadoClass = 'status-pendiente';
        if (estadoSafe.includes('listo')) estadoClass = 'status-listo';
        else if (estadoSafe.includes('prepar')) estadoClass = 'status-preparacion';
        tr.innerHTML = `
          <td>${p.id}</td>
          <td>${p.cliente || p.customer_name || ''}<div class="small">${p.email || (p.metadata&&p.metadata.email) || ''}</div></td>
          <td>${itemsHTML}</td>
          <td>$${p.total}</td>
          <td>${new Date(p.fecha || p.created_at || p.archived_at || Date.now()).toLocaleString()}</td>
          <td id="estado-${p.id}"><span class="status-badge ${estadoClass}">${estadoRaw}</span></td>
          <td class="actions">
            <button class="btn" data-action="preparacion" data-id="${p.id}">En preparación</button>
            <button class="btn secondary" data-action="listo" data-id="${p.id}">Listo</button>
            <button class="btn danger" data-action="notify" data-id="${p.id}">Notificar</button>
          </td>
        `;
        tabla.appendChild(tr);
      });

      // attach handlers
      tabla.querySelectorAll('button[data-action]').forEach(btn=>{
        btn.onclick = async (ev)=>{
          const id = btn.getAttribute('data-id');
          const action = btn.getAttribute('data-action');
          if (action === 'preparacion') return actualizar(id, 'En preparación');
          if (action === 'listo') return actualizar(id, 'Listo');
          if (action === 'notify') {
            await actualizar(id, 'Listo');
            // call server notify to send email if available
            try{
              const r = await fetch('/api/pedidos/' + encodeURIComponent(id) + '/notify', { method:'POST', credentials:'same-origin' });
              if (!r.ok) { const e = await r.json().catch(()=>({})); console.warn('Notify failed', e); }
            }catch(e){ console.warn('Notify error', e); }
          }
        };
      });
    }

    async function actualizar(id, estado) {
      try{
        const res = await fetch('/api/pedidos/' + encodeURIComponent(id), {
          method: 'PATCH',
          credentials: 'same-origin',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ estado })
        });
        if (!res.ok) {
          const err = await res.json().catch(()=>({ error: 'Unknown' }));
          alert('No se pudo actualizar el estado: ' + (err.error || JSON.stringify(err)));
          return;
        }
        const j = await res.json().catch(()=>null);
        const estadoText = j && j.pedido && j.pedido.estado ? j.pedido.estado : estado;
        const el = document.getElementById('estado-'+id);
        if (el) el.innerHTML = `<span class="status-badge ${String(estadoText).toLowerCase().includes('listo')? 'status-listo': (String(estadoText).toLowerCase().includes('prepar')? 'status-preparacion':'status-pendiente')}">${estadoText}</span>`;
      }catch(e){ alert('Error al actualizar: '+(e.message||e)); }
    }

    // ARCHIVE: fetch list of archived dates
    async function fetchArchives() {
      try{
        const r = await fetch('/api/admin/archives', { credentials: 'same-origin' });
        if (!r.ok) return;
        const j = await r.json();
        const body = document.getElementById('archivesBody');
        body.innerHTML = '';
        (j.archives||[]).forEach(a=>{
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td style="padding:8px;border-bottom:1px solid #eee">${a.date}</td>
            <td style="padding:8px;border-bottom:1px solid #eee">${a.count || 0}</td>
            <td style="padding:8px;border-bottom:1px solid #eee">${a.archived_by || '-'}</td>
            <td style="padding:8px;border-bottom:1px solid #eee">
              <button class="btn" data-archive-view="${a.date}">Ver</button>
              <button class="btn danger" data-archive-delete="${a.date}" style="margin-left:8px">Eliminar</button>
            </td>
          `;
          body.appendChild(tr);
        });
        if (!(j.archives||[]).length) body.innerHTML = '<tr><td colspan="4" style="padding:8px;color:#666">No hay listas archivadas</td></tr>';
      }catch(e){ console.warn('fetchArchives error', e); }
    }

    async function loadArchive(date) {
      if (!date) return;
      try{
        const r = await fetch('/api/admin/archives/' + encodeURIComponent(date), { credentials: 'same-origin' });
        if (!r.ok) { const err = await r.json().catch(()=>({})); alert('No se pudo cargar archivo: '+(err.error||r.status)); return; }
        const j = await r.json();
        isViewingArchive = true; currentArchiveDate = date;
        document.getElementById('btnShowLive').style.display = 'inline-block';
        document.getElementById('btnArchiveToday').style.display = 'none';
        document.getElementById('archiveInfo').textContent = 'Mostrando lista archivada: ' + date;
        // map archived orders to a uniform structure
        const orders = (j.orders||[]).map(o=>({ id: o.id || o.original_order_id || o.id, cliente: (o.metadata&&o.metadata.customer_name) || o.customer_name || o.customer || '', items: o.items || [], total: o.total || 0, fecha: o.archived_at || o.created_at || null, estado: o.status || 'archivado' }));
        renderPedidos(orders);
      }catch(e){ console.error('loadArchive error', e); alert('Error cargando archive'); }
    }

    async function archiveToday() {
      if (!confirm('¿Archivar todos los pedidos del día actual? Esta acción moverá las órdenes a archivo y limpiará la lista actual.')) return;
      try{
        const r = await fetch('/api/admin/archive-today', { method: 'POST', credentials: 'same-origin' });
        if (!r.ok) { const err = await r.json().catch(()=>({})); alert('Error archivando: '+(err.error||r.status)); return; }
        const j = await r.json();
        await fetchArchives();
        if (j.archived_at) {
          // try to load the archived date
          const d = (j.archived_at||'').slice(0,10);
          if (d) { await loadArchive(d); return; }
        }
        alert('Archivado completado. Refresca la lista para ver cambios.');
        // refresh live if not viewing archive
        if (!isViewingArchive) cargar();
      }catch(e){ console.error('archiveToday error', e); alert('Error al archivar'); }
    }

    function showLiveList() {
      isViewingArchive = false; currentArchiveDate = null;
      document.getElementById('btnShowLive').style.display = 'none';
      document.getElementById('btnArchiveToday').style.display = 'inline-block';
      document.getElementById('archiveInfo').textContent = '';
      cargar();
    }

    // attach UI handlers
    (function attachUI(){
      document.addEventListener('DOMContentLoaded', ()=>{
        const table = document.getElementById('archivesTable');
        table.addEventListener('click', (ev)=>{
          const v = ev.target.getAttribute && (ev.target.getAttribute('data-archive-view') || ev.target.getAttribute('data-archive-delete'));
          if (!v) return;
          if (ev.target.getAttribute('data-archive-view')) {
            loadArchive(v);
          } else if (ev.target.getAttribute('data-archive-delete')) {
            if (!confirm('¿Eliminar la lista archivada de fecha ' + v + '? Esta acción es irreversible.')) return;
            fetch('/api/admin/archives/' + encodeURIComponent(v), { method: 'DELETE', credentials: 'same-origin' })
              .then(r=>r.json()).then(j=>{ if (j && j.ok) { alert('Archivo eliminado'); fetchArchives(); showLiveList(); } else { alert('No se pudo eliminar: ' + (j && j.error)); } }).catch(e=>{ alert('Error al eliminar'); });
          }
        });
        document.getElementById('btnArchiveToday').onclick = archiveToday;
        document.getElementById('btnShowLive').onclick = showLiveList;
      });
    })();

    // initial load: fetch archives and live pedidos; refresh live every 5s only when not viewing archive
    (async ()=>{ await ensureAdmin(); await fetchArchives(); await cargar(); setInterval(()=>{ if (!isViewingArchive) cargar(); }, 5000); })();

  </script>
</body>
</html>

<script src="/scripts/input_filter.js"></script>