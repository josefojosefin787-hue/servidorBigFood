<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Pedidos - Admin</title>
  <link rel="stylesheet" href="/styles.css">
  <style>
    :root{ --green:#0b8e4d; --accent:#34a853; --muted:#6b6b6b }
    body.pedidos-page{ margin:0;font-family:Inter,system-ui,-apple-system,'Segoe UI',sans-serif;min-height:100vh;display:flex;align-items:center;justify-content:center;padding:40px 12px;background:linear-gradient(140deg,#0b8e4d 0%,#34a853 55%,#0b5e28 100%); }
    .pedidos-card{ width:100%;max-width:1100px;background:rgba(255,255,255,0.98);border-radius:18px;padding:22px;box-shadow:0 30px 60px rgba(6,62,30,0.22); }
    .pedidos-card h1{ margin:0 0 12px;color:var(--green) }
    .table-wrap{ overflow:auto }
    table.pedidos-table{ width:100%;border-collapse:collapse;min-width:860px }
    table.pedidos-table th, table.pedidos-table td{ padding:12px 10px;border-bottom:1px solid #eee;text-align:left;vertical-align:middle }
    table.pedidos-table th{ background:linear-gradient(90deg,rgba(11,94,42,0.06),rgba(11,94,42,0.02));color:var(--green);font-weight:600 }
    .actions { display:flex; gap:8px }
    .btn{ background:var(--green); color:#fff; border:0; padding:8px 10px; border-radius:8px; cursor:pointer; font-weight:600 }
    .btn.secondary{ background:#f0ad4e }
    .btn.danger{ background:#d9534f }
    .status-badge{ padding:6px 10px;border-radius:999px;font-weight:700;display:inline-block }
    .status-pendiente{ background:#fff3cd;color:#856404 }
    .status-preparacion{ background:#cfe2ff;color:#084298 }
    .status-listo{ background:#d1e7dd;color:#0f5132 }
    .small{ font-size:0.9rem; color:var(--muted) }
    @media (max-width:900px){ .pedidos-card{ padding:18px } table.pedidos-table th, table.pedidos-table td{ padding:10px } }
  </style>
</head>
<body class="pedidos-page">
  <div class="pedidos-card">
    <h1>Lista de pedidos</h1>
    <p class="small">Vista de administración — solo usuarios autenticados pueden ver y gestionar pedidos.</p>
    <div class="table-wrap">
      <table class="pedidos-table" aria-label="Lista de pedidos">
        <thead>
          <tr><th>ID</th><th>Cliente</th><th>Items</th><th>Total</th><th>Fecha</th><th>Estado</th><th>Acción</th></tr>
        </thead>
        <tbody id="tabla"></tbody>
      </table>
    </div>
  </div>

  <script>
    // admin-only page: verify session first
    async function ensureAdmin() {
      try{
        const r = await fetch('/api/admin/session', { credentials: 'same-origin' });
        if (!r.ok) { window.location.href = '/admin-login.html'; return false; }
        return true;
      }catch(e){ window.location.href = '/admin-login.html'; return false; }
    }

    async function cargar() {
      const ok = await ensureAdmin();
      if (!ok) return;

      const res = await fetch('/api/pedidos', { credentials: 'same-origin' });
      if (!res.ok) { console.error('Error fetching pedidos', res.status); return; }
      const pedidos = await res.json();
      const tabla = document.getElementById('tabla');
      tabla.innerHTML = '';

      pedidos.slice().reverse().forEach(p=>{
        const tr = document.createElement('tr');
        const itemsHTML = (p.items||[]).map(i=> (i.cantidad||1) + ' x ' + (i.nombre||i.name||'')).join('<br>');
        const estadoRaw = String(p.estado||'').trim();
        const estadoSafe = estadoRaw.toLowerCase();
        let estadoClass = 'status-pendiente';
        if (estadoSafe.includes('listo')) estadoClass = 'status-listo';
        else if (estadoSafe.includes('prepar')) estadoClass = 'status-preparacion';
        tr.innerHTML = `
          <td>${p.id}</td>
          <td>${p.cliente || ''}<div class="small">${p.email || ''}</div></td>
          <td>${itemsHTML}</td>
          <td>$${p.total}</td>
          <td>${new Date(p.fecha).toLocaleString()}</td>
          <td id="estado-${p.id}"><span class="status-badge ${estadoClass}">${estadoRaw}</span></td>
          <td class="actions">
            <button class="btn" data-action="preparacion" data-id="${p.id}">En preparación</button>
            <button class="btn secondary" data-action="listo" data-id="${p.id}">Listo</button>
            <button class="btn danger" data-action="notify" data-id="${p.id}">Notificar</button>
          </td>
        `;
        tabla.appendChild(tr);
      });

      // attach handlers
      tabla.querySelectorAll('button[data-action]').forEach(btn=>{
        btn.onclick = async (ev)=>{
          const id = btn.getAttribute('data-id');
          const action = btn.getAttribute('data-action');
          if (action === 'preparacion') return actualizar(id, 'En preparación');
          if (action === 'listo') return actualizar(id, 'Listo');
          if (action === 'notify') {
            await actualizar(id, 'Listo');
            // call server notify to send email if available
            try{
              const r = await fetch('/api/pedidos/' + encodeURIComponent(id) + '/notify', { method:'POST', credentials:'same-origin' });
              if (!r.ok) { const e = await r.json().catch(()=>({})); console.warn('Notify failed', e); }
            }catch(e){ console.warn('Notify error', e); }
          }
        };
      });
    }

    async function actualizar(id, estado) {
      try{
        const res = await fetch('/api/pedidos/' + encodeURIComponent(id), {
          method: 'PATCH',
          credentials: 'same-origin',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ estado })
        });
        if (!res.ok) {
          const err = await res.json().catch(()=>({ error: 'Unknown' }));
          alert('No se pudo actualizar el estado: ' + (err.error || JSON.stringify(err)));
          return;
        }
        const j = await res.json().catch(()=>null);
        const estadoText = j && j.pedido && j.pedido.estado ? j.pedido.estado : estado;
        const el = document.getElementById('estado-'+id);
        if (el) el.innerHTML = `<span class="status-badge ${String(estadoText).toLowerCase().includes('listo')? 'status-listo': (String(estadoText).toLowerCase().includes('prepar')? 'status-preparacion':'status-pendiente')}">${estadoText}</span>`;
      }catch(e){ alert('Error al actualizar: '+(e.message||e)); }
    }

    // refresh loop
    (async ()=>{ await cargar(); setInterval(cargar, 5000); })();

  </script>
</body>
</html>